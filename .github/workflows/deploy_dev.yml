name: Deploy Dev

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set deploy start time
        run: echo "DEPLOY_START=$(date +%s)" >> $GITHUB_ENV

      - name: Send Telegram notification (start)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="üöÄ <b>–î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω!</b>

          üë§ <b>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</b> ${{ github.actor }}
          üì¶ <b>–ü—Ä–æ–µ–∫—Ç:</b> sm-front
          üåø <b>–í–µ—Ç–∫–∞:</b> ${{ github.ref_name }}

          üìù <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∫–æ–º–º–∏—Ç—É:</b>
            - ${{ github.event.head_commit.message }}"

      - name: Deploy via SSH (DEV)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            echo "üîÑ Updating DEV environment..."

            cd /var/www/mobistore/front
            git reset --hard
            git pull --rebase origin dev

            cd deploy

            docker compose stop nuxt-dev 2>/dev/null || true
            docker compose rm -f nuxt-dev 2>/dev/null || true
            docker compose up -d --build nuxt-dev

            docker image prune -f

            echo "‚úÖ DEV Deploy complete!"

      - name: Send Telegram notification (success)
        if: success()
        run: |
          DEPLOY_END=$(date +%s)
          DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚úÖ <b>–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!</b>

          üì¶ <b>–ü—Ä–æ–µ–∫—Ç:</b> sm-front
          üåø <b>–í–µ—Ç–∫–∞:</b> ${{ github.ref_name }}
          üïí <b>–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:</b> ${DEPLOY_TIME}s

          üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –±–µ–∑ –æ—à–∏–±–æ–∫."

      - name: Send Telegram notification (failure)
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_DEPLOY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_DEPLOY_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚ùå <b>–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!</b>

          üì¶ <b>–ü—Ä–æ–µ–∫—Ç:</b> sm-front
          üåø <b>–í–µ—Ç–∫–∞:</b> ${{ github.ref_name }}
          üë§ <b>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</b> ${{ github.actor }}

          ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
